<!DOCTYPE html>
<html lang="en">

<head>
    <title>MST3K Riffed Movie Connections</title>

    <link rel="stylesheet" href="https://cdn.usebootstrap.com/bootstrap/latest/css/bootstrap.min.css">
    <script src="https://cdn.usebootstrap.com/bootstrap/latest/js/bootstrap.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>

    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js" type="text/javascript"></script>

    <style type="text/css">
        #mst3kgraph {
            border: 1px solid lightgray;
        }
    </style>

</head>

<body>

    <div class="container">
        <p><a href="index.html">home</a> | <a href="involvement.html">involvement</a> | <a href="movie_graph.html">movie graph</a> | movie/crew graph </p>

        <h1>MST3K Riffed Movie/Crew Graph</h1>
        <p>
            This is a graph of riffed movies where the conections indicate that a actor, director or writer
            was involved with both of the connected movies.
        </p>

        <div id="progress" class="container">
            <div class="row">
                <div class="col-sm-3">
                    <div class="progress">
                        <div id="progressBar" class="progress-bar" role="progressbar"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container w-100" id="mst3kgraph" style="height:800px; background-color:ghostwhite;">

        </div>

    </div>


    <script type="text/javascript">
        // create an array with nodes

        var _episodes = null;
        var _crew = null;

        var nodes = null;
        var edges = null;

        function filterEpisodes(data){
            _episodes = {};
            for( var episodeId in data ) {
                var episode = data[episodeId];
                if( typeof _episodes[episode.tconst] != 'undefined ') {
                    var node = {
                        "id": episode.tconst,
                        "label": episode.episode,
                        "title": episode.title,
                        "shape": "box",
                        "color": "gold",
                        "host": episode.host
                    }
                    _episodes[episode.tconst] = node;
                } else {
                    _episodes[episode.tconst].label += ","+episode.episode;
                    if( _episodes[episode.tconst].host != episode.host ) {
                        _episodes[episode.tconst].host += ","+episode.host;
                    }
                }
            }
            dataAdded();
        }


        function filterCrew(data){
            _crew = {};
            for( var crewId in data ) {
                _crew[crewId] = data[crewId];
                for( var i in data[crewId].titles ) {
                    var titleId = data[crewId].titles[i];
                    console.log( titleId );
                    if( typeof _episodes[titleId].count == 'undefined' ){
                        _episodes[titleId].count = 1;
                    } else {
                        _episodes[titleId].count++;
                    }
                }
            }
            dataAdded();
        }

        $( document ).ready(function() {

            $.ajax({
		       url: "data/mst3k_episodes.json",
		       dataType: 'json',
		       success: filterEpisodes,
		       crossDomain:true
		    });

            $.ajax({
		       url: "data/crew_data.json",
		       dataType: 'json',
		       success: filterCrew,
		       crossDomain:true
		    });
            
        });

        function dataAdded(){
            if( _episodes != null && _crew != null ){

                var tedges = [];
                var tnodes = [];
                for( var episodeId in _episodes ) {
                    var episode = _episodes[episodeId];
                    // filter
                    if( typeof episode.count != 'undefined' ) {
                        tnodes.push( _episodes[episodeId] );
                    }
                }

                for( var crewId in _crew ) {
                    var crewMember = _crew[crewId];
                    if( crewMember.titles.length > 1 ) {
                        var node = {
                            "id": crewId,
                            "label": _crew[crewId].name,
                            "shape":"ellipse",
                            "color":"gainsboro"
                        }
                        tnodes.push( node );

                        for( var c in crewMember.titles ) {
                            var edge = {
                                "from": crewId,
                                "to": crewMember.titles[c]
                            }
                            tedges.push(edge);
                        }
                    }
                } 
                nodes = new vis.DataSet(tnodes);
                edges = new vis.DataSet(tedges);

                // arcs

                var data = {
                    "nodes": nodes,
                    "edges": edges,
                };
                buildGraph(data)
            }
        }

        function buildGraph(data){
            var container = document.getElementById("mst3kgraph");
            var options = {
                interaction: { hover: true },
                manipulation: { enabled: false }
            };

            var network = new vis.Network(container, data, options);

            network.on("stabilizationProgress", function (params) {
                var widthFactor = parseInt( params.iterations / params.total * 100 );

                $("#progressBar")
                    .css("width", widthFactor + "%")
                    .attr("aria-valuenow", widthFactor)
                    .text(widthFactor + "%");
            });

            network.once("stabilizationIterationsDone", function () {
                $("#progressBar")
                    .css("width", "100%")
                    .attr("aria-valuenow", 100)
                    .text("100% progress");

                setTimeout(function () {
                    $('#progressBar').addClass('.d-none');
                    console.log("hiding")
                }, 1000);
            });

            network.on("click", function (params) {
                params.event = "[original event]";
                document.getElementById("eventSpanHeading").innerText = "Click event:";
                document.getElementById("eventSpanContent").innerText = JSON.stringify(
                    params,
                    null,
                    4
                );
                console.log(
                    "click event, getNodeAt returns: " +
                    this.getNodeAt(params.pointer.DOM)
                );
            });
        }


    </script>
</body>

</html>