<!DOCTYPE html>
<html lang="en">

<head>
    <title>MST3K Riffed Movie Connections</title>

    <link rel="stylesheet" href="https://cdn.usebootstrap.com/bootstrap/latest/css/bootstrap.min.css">
    <script src="https://cdn.usebootstrap.com/bootstrap/latest/js/bootstrap.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>

    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js" type="text/javascript"></script>

    <style type="text/css">
        #mst3kgraph {
            border: 1px solid lightgray;
        }
    </style>

</head>

<body>

    <div class="container">
        <p><a href="index.html">home</a> | <a href="involvement.html">involvement</a> | movie graph | <a href="movie_crew_graph.html">movie/crew graph</a> </p>

        <h1>MST3K Riffed Movie Graph</h1>
        <p>
            This is a graph of riffed movies where the conections indicate that a actor, director or writer
            was involved with both of the connected movies.
        </p>

        <div class="row">
            <div id="progress" class="container">
                <div class="row">
                    <div class="col-sm-3">
                        <div class="progress">
                            <div id="progressBar" class="progress-bar" role="progressbar"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row" style="padding-top: 1em;">
            <div class="col-sm-9">
                <!-- <div class="container" style="background-color:ghostwhite; height: 600px;"></div> -->
                <div class="container" id="mst3kgraph" style="background-color:ghostwhite; height: 600px;"></div>
            </div>
            <div id="details" class="col-sm-3">

            </div>
        </div>

    </div>


    <script type="text/javascript">
        // create an array with nodes

        var _episodes = null;
        var _crew = null;

        var nodes = null;
        var edges = null;

        var currentHighlight = null;

        function filterEpisodes(data){
            _episodes = {};
            for( var episodeId in data ) {
                var episode = data[episodeId];
                if( typeof _episodes[episode.tconst] != 'undefined ') {
                    var node = {
                        "id": episode.tconst,
                        "label": episode.episode,
                        "title": episode.title,
                        "shape": "box",
                        "color": "gold",
                        "host": episode.host
                    }
                    _episodes[episode.tconst] = node;
                } else {
                    _episodes[episode.tconst].label += ","+episode.episode;
                    if( _episodes[episode.tconst].host != episode.host ) {
                        _episodes[episode.tconst].host += ","+episode.host;
                    }
                }
            }
            dataAdded();
        }


        function filterCrew(data){
            _crew = {};
            for( var crewId in data ) {
                _crew[crewId] = data[crewId];
                for( var i in data[crewId].titles ) {
                    var titleId = data[crewId].titles[i];
                    if( typeof _episodes[titleId].count == 'undefined' ){
                        _episodes[titleId].count = 1;
                    } else {
                        _episodes[titleId].count++;
                    }
                }
            }
            dataAdded();
        }

        $( document ).ready(function() {

            $.ajax({
		       url: "data/mst3k_episodes.json",
		       dataType: 'json',
		       success: filterEpisodes,
		       crossDomain:true
		    });

            $.ajax({
		       url: "data/crew_data.json",
		       dataType: 'json',
		       success: filterCrew,
		       crossDomain:true
		    });
            
        });

        function dataAdded(){
            if( _episodes != null && _crew != null ){

                var tedges = [];
                var tnodes = [];
                for( var episodeId in _episodes ) {
                    var episode = _episodes[episodeId];
                    // filter
                    if( typeof episode.count != 'undefined' ) {
                        _episodes[episodeId].connections=[];
                        tnodes.push( _episodes[episodeId] );
                    }
                }

                var dups = [];
                for( var crewId in _crew ) {
                    var crewMember = _crew[crewId];
                    if( crewMember.titles.length > 1 ) {

                        for( var i=0; i<crewMember.titles.length; i++ ) {
                            for( var j=i+1; j<crewMember.titles.length; j++ ) {
                                var key1 = crewMember.titles[i]  + "-" + crewMember.titles[j];
                                var key2 = crewMember.titles[j]  + "-" + crewMember.titles[i];
                                if( !dups.includes(key1) && !dups.includes(key2) ){
                                    var edge = {
                                        "from": crewMember.titles[i],
                                        "to": crewMember.titles[j],
                                        "color": "black"
                                    }
                                    tedges.push(edge);
                                    dups.push(key1);
                                    dups.push(key2);

                                    var connection = {
                                        "title": _episodes[crewMember.titles[i]].title,
                                        "through": crewMember.name
                                    }
                                    var episode = _episodes[crewMember.titles[j]];
                                    episode.connections.push(connection);

                                    connection = {
                                        "title": _episodes[crewMember.titles[j]].title,
                                        "through": crewMember.name
                                    }
                                    episode = _episodes[crewMember.titles[i]];
                                    episode.connections.push(connection);

                                }
                            }
                        }
                    }
                } 
                nodes = new vis.DataSet(tnodes);
                edges = new vis.DataSet(tedges);

                // arcs

                var data = {
                    "nodes": nodes,
                    "edges": edges,
                };
                buildGraph(data)
            }
        }

        function buildGraph(data){
            var container = document.getElementById("mst3kgraph");
            var options = {
                interaction: { hover: true },
                manipulation: { enabled: false }
            };

            var network = new vis.Network(container, data, options);

            network.on("stabilizationProgress", function (params) {
                var widthFactor = parseInt( params.iterations / params.total * 100 );

                $("#progressBar")
                    .css("width", widthFactor + "%")
                    .attr("aria-valuenow", widthFactor)
                    .text(widthFactor + "%");
            });

            network.once("stabilizationIterationsDone", function () {
                $("#progressBar")
                    .css("width", "100%")
                    .attr("aria-valuenow", 100)
                    .text("100% progress");

                setTimeout(function () {
                    $('#progressBar').addClass('.d-none');
                }, 1000);
            });

            network.on("click", function (params) {
                
                if( params.nodes.length > 0 ){
                    $('#details').empty();
                    $('#details').css("background","");

                    if( currentHighlight == params.nodes[0] ){
                        // toggle off
                        currentHighlight = null;
                    } else {
                        $('#details').empty();
                        $('#details').css("background","");

                        var titleId = params.nodes[0];
                        var episode = _episodes[titleId];
                        var title = episode.title;
                        var label = episode.label;

                        if( episode.connections.length > 0 ) {

                            var lineItems = ""; //JSON.stringify(episode);

                            for( var i=0; i<episode.connections.length; i++){
                                var connection = episode.connections[i];
                                lineItems += `<li><b>${connection.title}</b> <i>via ${connection.through}</i></li>`;
                            }

                            var detailsElm = 
                                `<h4>${title} (${label})</h4>
                                <p><a href="https://www.imdb.com/title/${titleId}" target="_blank">imdb</a> &nbsp;<img src="images/extlink.png" width="14"></p>
                                Connected to
                                <ul>${lineItems}</ul>`;

                            $('#details').append(detailsElm);
                            $('#details').css("background","antiquewhite");
                        } else {
                            var detailsElm = 
                                `<h4>${title} (${label})</h4>
                                <p><a href="https://www.imdb.com/title/${titleId}" target="_blank">imdb</a> &nbsp;<img src="images/extlink.png" width="14"></p>
                                <p>No connections</p>`;

                            $('#details').append(detailsElm);
                            $('#details').css("background","antiquewhite");
                            
                        }
                        currentHighlight = titleId;
                    }


                }
            });
        }

    </script>
</body>

</html>