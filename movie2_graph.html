<!DOCTYPE html>
<html lang="en">

<head>
    <title>MST3K Riffed Movie Explorer</title>

    <link rel="stylesheet" href="https://cdn.usebootstrap.com/bootstrap/latest/css/bootstrap.min.css">
    <script src="https://cdn.usebootstrap.com/bootstrap/latest/js/bootstrap.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>

    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js" type="text/javascript"></script>

    <style type="text/css">
        #mst3kgraph {
            border: 1px solid darkgray;
        }

        ul {
            list-style-image: url('images/ladd.png');
        }
    </style>

</head>

<body>

    <div class="container">
        <p><a href="index.html">home</a> | <a href="movies.html">listing</a> | <a href="involvement.html">involvement</a> | <a href="movie_graph.html">movie graph</a> | <a href="movie_connections.html">top movie connections</a> </p>

        <h1>MST3K Riffed Movie Explorer</h1>
        <p>
            In this interactive graph there is an initial vertex of a MST3K riffed movie.  Selecting a vertex will display the connected movies (and actors with the connection).
            
        </p>
        <p>TODO: document this page</p>

        <div class="row" style="padding-top: 1em;">
            <div class="col-sm-9">
                <!-- <div class="container" style="background-color:ghostwhite; height: 600px;"></div> -->
                <div class="container" id="mst3kgraph" style="background-color:ghostwhite; height: 600px;"></div>
            </div>
            <div id="details" class="col-sm-3">

            </div>
        </div>

    </div>


    <script type="text/javascript">
        // create an array with nodes

        var network;

        var episodes;
        var crew;

        var currentHighlight = null;

        var nodes = new vis.DataSet([]);
        var edges = new vis.DataSet([]);
        var graphData = {
            "nodes": nodes,
            "edges": edges,
        };

        $( document ).ready(function() {
            $.ajax({
		       url: "data/all_data.json",
		       dataType: 'json',
		       success: getData,
		       crossDomain:true
		    });
        });

        function getData(data){

            crew = data.crew;
            episodes = data.episodes;

            // now lets create compute the connections
            var dups = [];
            for( var tconst in episodes ) {
                var connections = getConnections( tconst );
                for( var connection of connections ){
                    if( typeof episodes[tconst].connections == 'undefined' ) episodes[tconst].connections = [];
                    episodes[tconst].connections.push( connection );
                }
                //console.log( JSON.stringify(episodes[tconst],null,4) );
            }

            buildGraph();

            var queryParams = new URLSearchParams(window.location.search);
            var tconst = queryParams.get("tconst"); 

            var episode = episodes[tconst];

            var starterNode = {
                        "id": tconst,
                        "label": episode.episode,
                        "title": episode.title,
                        "shape": "box",
                        "color": "gold",
                        "host": episode.host
                    }
            nodes.add(starterNode);

            addedTitles.push(tconst);
        }


        function getRelatedTitles(nconst) {
            var allTitles = [];
            var crewMember = crew[nconst];
            for (var tconst of crewMember.actor) {
                if (!allTitles.includes(tconst) ) {
                    allTitles.push(tconst);
                }
            }
            for (var tconst of crewMember.director) {
                if (!allTitles.includes(tconst)) {
                    allTitles.push(tconst);
                }
            }
            for (var tconst of crewMember.writer) {
                if (!allTitles.includes(tconst) ) {
                    allTitles.push(tconst);
                }
            }
            return allTitles;
        }

        function getRelatedCrew(tconst) {
            var allCrew = [];
            var episode = episodes[tconst];
            for (var nconst of episode.actors) {
                if (!allCrew.includes(nconst)) {
                    allCrew.push(nconst);
                }
            }
            for (var nconst of episode.directors) {
                if (!allCrew.includes(nconst)) {
                    allCrew.push(nconst);
                }
            }
            for (var nconst of episode.writers) {
                if (!allCrew.includes(nconst)) {
                    allCrew.push(nconst);
                }
            }
            return allCrew;
        }

        function getConnections( tconst ) {
            var connections = [];
            var rcrew = getRelatedCrew(tconst);
            for( var nconst of rcrew ) {
                var rtitles = getRelatedTitles(nconst);
                for( var rtitle of rtitles ) {
                    if( tconst != rtitle.tconst ){
                        var t = episodes[rtitle.tconst].title;
                        var connection = {
                            "tconst": rtitle.tconst,
                            "title": episodes[rtitle.tconst].title,
                            "through": crew[nconst].name
                        }
                        connections.push(connection);
                    }
                }
            }
            return connections;
        }

        function buildGraph(){

            var container = document.getElementById("mst3kgraph");
            var options = {
                interaction: { hover: true },
                manipulation: { enabled: false },
                layout: { improvedLayout: false }
            };

            network = new vis.Network(container, graphData, options);
            network.on("click",highlightEpisode);

        }


        var highlightedEpisode = null;
        function highlightEpisode(params){

            $('#details').empty();
            $('#details').css("background","");

            if( params.nodes.length > 0 ){
                if( currentHighlight == params.nodes[0] ){
                    // toggle off
                    currentHighlight = null;
                } else {
                    var titleId = params.nodes[0];
                        var episode = episodes[titleId];
                        var title = episode.title;
                        var label = episode.episode;
                        var year = episode.year;

                        if (Array.isArray(episode.connections) && episode.connections.length > 0) {

                            var connectionSet = {};

                            for (var i = 0; i < episode.connections.length; i++) {
                                var connection = episode.connections[i];
                                // if( useEpisode(connection.tconst) ) {
                                    if( typeof connectionSet[connection.tconst] == 'undefined'  ){
                                    connectionSet[connection.tconst] = 
                                        {
                                            "title": connection.title,
                                            "through": connection.through
                                        };
                                    } else {
                                        connectionSet[connection.tconst].through += ", "+connection.through;
                                    }
                                // }
                            }

                            var lineItems = ""; //JSON.stringify(episode);
                            for( var tconst in connectionSet ){
                                var connection = connectionSet[tconst];
                                lineItems += `<li onclick="addTitle('${tconst}')"><b>${connection.title}</b> <i>via ${connection.through}</i></li>`;
                            }

                            var detailsElm =
                                `<h4>${title}, ${year} (${label}) &nbsp; <a href="https://www.imdb.com/title/${titleId}" target="_blank"><img src="images/imdb.png" width="24"></a></h4>
                                Connected to
                                <ul>${lineItems}</ul>`;

                            $('#details').append(detailsElm);
                            $('#details').css("background", "antiquewhite");
                        } else {
                            var detailsElm =
                                `<h4>${title}, ${year}  (${label}) &nbsp; <a href="https://www.imdb.com/title/${titleId}" target="_blank"><img src="images/imdb.png" width="24"></a></h4>
                                <p>No connections</p>`;

                            $('#details').append(detailsElm);
                            $('#details').css("background", "antiquewhite");

                        }
                        currentHighlight = titleId;
                    }
                }
        }

        function getAllTitles( nconst ) {
            var allTitles = [];
            var crewMember = crew[nconst];
            for( var tconst of crewMember.actor ) {
                if( !allTitles.includes(tconst) ){
                    allTitles.push( tconst );
                }
            }
            for( var tconst of crewMember.director ) {
                if( !allTitles.includes(tconst) ){
                    allTitles.push( tconst );
                }
            }
            for( var tconst of crewMember.writer ) {
                if( !allTitles.includes(tconst) ){
                    allTitles.push( tconst );
                }
            }
            return allTitles;
        }

        function getAllCrew( tconst ) {
            var allCrew = [];
            var episode = episodes[tconst];
            for( var nconst of episode.actors ) {
                if( !allCrew.includes(nconst) ){
                    allCrew.push( nconst );
                }
            }
            for( var nconst of episode.directors ) {
                if( !allCrew.includes(nconst) ){
                    allCrew.push( nconst );
                }
            }
            for( var nconst of episode.writers ) {
                if( !allCrew.includes(nconst) ){
                    allCrew.push( nconst );
                }
            }
            return allCrew;
        }

        function addConnections(nconst){
            var crewMember = crew[nconst];
            var allTitles = getAllTitles(nconst);
            for( var tconst of allTitles ){
                addNodesFromEpisode(tconst,nconst)
            }
        }

        var addedEdges = [];
        var addedTitles = [];

        function addTitle(tconst){

            if( !addedTitles.includes(tconst) ) {

                network.setOptions( { physics: { enabled: true } } );

                var episode = episodes[tconst];

                var node = {
                        "id": tconst,
                        "label": episode.episode,
                        "title": episode.title,
                        "shape": "box",
                        "color": "gold",
                        "host": episode.host
                }
                nodes.add(node);
                addedTitles.push(tconst);

                // find all connections of the to be added title
                // to see if we need to add some edges to existing 
                // nodes
                var connections = getConnections( tconst );

                for( var connection of connections ) {
                    if( !addedEdges.includes( connection.tconst+'-'+tconst) ){
                        var edge = {
                            "to": connection.tconst,
                            "from": tconst
                        }
                        edges.add(edge);

                        addedEdges.push( connection.tconst+'-'+tconst );
                        addedEdges.push( tconst+'-'+connection.tconst );
                    }

                }

            }

        }


    </script>
</body>

</html>